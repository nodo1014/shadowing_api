<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>클립 상세 정보</title>
    <link rel="stylesheet" href="frontend/css/styles.css">
    <link rel="stylesheet" href="frontend/css/app.css">
    <style>
        .detail-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--gray-200);
        }
        
        .detail-title {
            font-size: 24px;
            font-weight: 600;
            color: var(--gray-900);
        }
        
        .detail-actions {
            display: flex;
            gap: 10px;
        }
        
        .detail-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        
        .video-section {
            background: var(--gray-50);
            border-radius: 8px;
            padding: 20px;
        }
        
        .video-player {
            width: 100%;
            background: #000;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        
        .video-player video {
            width: 100%;
            height: auto;
            display: block;
        }
        
        .no-video {
            height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--gray-200);
            color: var(--gray-600);
            border-radius: 4px;
            margin-bottom: 20px;
        }
        
        .info-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .info-card {
            background: var(--gray-50);
            border-radius: 8px;
            padding: 20px;
        }
        
        .info-card h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--gray-900);
        }
        
        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--gray-200);
        }
        
        .info-item:last-child {
            border-bottom: none;
        }
        
        .info-label {
            font-weight: 500;
            color: var(--gray-600);
        }
        
        .info-value {
            color: var(--gray-900);
            text-align: right;
        }
        
        .subtitle-card {
            background: var(--gray-50);
            border-radius: 8px;
            padding: 20px;
        }
        
        .subtitle-text {
            font-size: 16px;
            line-height: 1.8;
            margin-bottom: 10px;
            padding: 10px;
            background: white;
            border-radius: 4px;
        }
        
        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            color: var(--primary);
            text-decoration: none;
            margin-bottom: 20px;
        }
        
        .back-link:hover {
            text-decoration: underline;
        }
        
        @media (max-width: 768px) {
            .detail-content {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="detail-container">
        <a href="/" class="back-link">
            ← 클립 관리로 돌아가기
        </a>
        
        <div class="detail-header">
            <h1 class="detail-title" id="clip-title">클립 상세 정보</h1>
            <div class="detail-actions" id="detail-actions">
                <!-- 동적으로 추가됨 -->
            </div>
        </div>
        
        <div class="detail-content">
            <!-- 비디오 섹션 -->
            <div class="video-section">
                <div id="video-container">
                    <!-- 동적으로 추가됨 -->
                </div>
                
                <!-- 기본 정보 -->
                <div class="info-card">
                    <h3>기본 정보</h3>
                    <div class="info-item">
                        <span class="info-label">작업 ID</span>
                        <span class="info-value" id="job-id">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">생성일시</span>
                        <span class="info-value" id="created-at">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">상태</span>
                        <span class="info-value" id="status">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">미디어 파일</span>
                        <span class="info-value" id="media-file">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">구간</span>
                        <span class="info-value" id="time-range">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">템플릿</span>
                        <span class="info-value" id="template">-</span>
                    </div>
                </div>
            </div>
            
            <!-- 정보 섹션 -->
            <div class="info-section">
                <!-- 자막 정보 -->
                <div class="subtitle-card">
                    <h3>자막 정보</h3>
                    <div class="subtitle-text" id="text-eng">
                        -
                    </div>
                    <div class="subtitle-text" id="text-kor">
                        -
                    </div>
                </div>
                
                <!-- 추가 정보 -->
                <div class="info-card">
                    <h3>추가 정보</h3>
                    <div class="info-item">
                        <span class="info-label">설명</span>
                        <span class="info-value" id="note">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">키워드</span>
                        <span class="info-value" id="keywords">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">출력 파일</span>
                        <span class="info-value" id="output-file">-</span>
                    </div>
                </div>
                
                <!-- YouTube 업로드 정보 (있는 경우) -->
                <div class="info-card" id="youtube-info" style="display: none;">
                    <h3>YouTube 업로드 정보</h3>
                    <div id="youtube-details">
                        <!-- 동적으로 추가됨 -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="frontend/js/common.js"></script>
    <script src="frontend/js/youtube.js"></script>
    <script>
        // URL 파라미터에서 job ID 가져오기
        const urlParams = new URLSearchParams(window.location.search);
        const jobId = urlParams.get('id');
        
        if (!jobId) {
            window.location.href = '/';
        }
        
        // 작업 상세 정보 로드
        async function loadJobDetail() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/job/${jobId}`);
                if (!response.ok) {
                    throw new Error('Failed to load job details');
                }
                
                const job = await response.json();
                displayJobDetail(job);
            } catch (error) {
                console.error('Error loading job:', error);
                showError('작업 정보를 불러올 수 없습니다.');
            }
        }
        
        // 작업 정보 표시
        function displayJobDetail(job) {
            // 제목
            const mediaName = job.media_path ? job.media_path.split('/').pop() : 'N/A';
            document.getElementById('clip-title').textContent = mediaName;
            
            // 비디오
            const videoContainer = document.getElementById('video-container');
            if (job.status === 'completed' && job.output_file) {
                videoContainer.innerHTML = `
                    <div class="video-player">
                        <video src="${API_BASE_URL}/api/video/${job.id}" 
                               controls
                               controlsList="nodownload">
                        </video>
                    </div>
                `;
            } else {
                videoContainer.innerHTML = `
                    <div class="no-video">
                        <span>${job.status === 'processing' ? '처리중...' : '비디오 없음'}</span>
                    </div>
                `;
            }
            
            // 기본 정보
            document.getElementById('job-id').textContent = job.id;
            document.getElementById('created-at').textContent = formatDate(job.created_at);
            document.getElementById('status').innerHTML = `<span class="status-badge ${job.status}">${getStatusText(job.status)}</span>`;
            document.getElementById('media-file').textContent = mediaName;
            document.getElementById('media-file').title = job.media_path || '';
            document.getElementById('time-range').textContent = `${job.start_time ? job.start_time.toFixed(1) : '0'}s - ${job.end_time ? job.end_time.toFixed(1) : '0'}s (${job.start_time && job.end_time ? (job.end_time - job.start_time).toFixed(1) : '0'}초)`;
            document.getElementById('template').textContent = job.template_number ? `Template ${job.template_number}` : `Type ${job.clipping_type || 1}`;
            
            // 자막 정보
            document.getElementById('text-eng').textContent = job.text_eng || '영문 자막 없음';
            document.getElementById('text-kor').textContent = job.text_kor || '한글 자막 없음';
            
            // 추가 정보
            document.getElementById('note').textContent = job.note || '-';
            document.getElementById('keywords').textContent = job.keywords ? job.keywords.join(', ') : '-';
            document.getElementById('output-file').textContent = job.output_file ? job.output_file.split('/').pop() : '-';
            
            // 액션 버튼
            const actionsContainer = document.getElementById('detail-actions');
            if (job.status === 'completed' && job.output_file) {
                actionsContainer.innerHTML = `
                    <button class="download-btn" onclick="downloadJob('${job.id}')">다운로드</button>
                    <button class="youtube-btn" onclick="showYouTubeUploadModal('${job.id}')" title="YouTube에 업로드">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                            <path d="M8.051 1.999h.089c.822.003 4.987.033 6.11.335a2.01 2.01 0 0 1 1.415 1.42c.101.38.172.883.22 1.402l.01.104.022.26.008.104c.065.914.073 1.77.074 1.957v.075c-.001.194-.01 1.108-.082 2.06l-.008.105-.009.104c-.05.572-.124 1.14-.235 1.558a2.007 2.007 0 0 1-1.415 1.42c-1.16.312-5.569.334-6.18.335h-.142c-.309 0-1.587-.006-2.927-.052l-.17-.006-.087-.004-.171-.007-.171-.007c-1.11-.049-2.167-.128-2.654-.26a2.007 2.007 0 0 1-1.415-1.419c-.111-.417-.185-.986-.235-1.558L.09 9.82l-.008-.104A31.4 31.4 0 0 1 0 7.68v-.122C.002 7.343.01 6.6.064 5.78l.007-.103.003-.052.008-.104.022-.26.01-.104c.048-.519.119-1.023.22-1.402a2.007 2.007 0 0 1 1.415-1.42c.487-.13 1.544-.21 2.654-.26l.17-.007.172-.006.086-.003.171-.007A99.788 99.788 0 0 1 7.858 2h.193zM6.4 5.209v4.818l4.157-2.408L6.4 5.209z"/>
                        </svg>
                        YouTube 업로드
                    </button>
                `;
            } else {
                actionsContainer.innerHTML = `
                    <button class="delete-btn" onclick="deleteJobAndReturn('${job.id}')">삭제</button>
                `;
            }
            
            // allJobs를 설정하여 YouTube 업로드 모달이 작동하도록 함
            window.allJobs = [job];
        }
        
        // 작업 다운로드
        window.downloadJob = function(jobId) {
            window.open(`${API_BASE_URL}/api/download/${jobId}`, '_blank');
        }
        
        // 작업 삭제 후 목록으로 돌아가기
        window.deleteJobAndReturn = async function(jobId) {
            if (!confirm('이 작업을 삭제하시겠습니까?')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/job/${jobId}?force=true`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showSuccess('작업이 삭제되었습니다.');
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 1000);
                } else {
                    throw new Error('삭제 실패');
                }
            } catch (error) {
                console.error('Delete failed:', error);
                showError('작업 삭제에 실패했습니다.');
            }
        }
        
        // 페이지 로드 시 작업 정보 로드
        loadJobDetail();
    </script>
</body>
</html>