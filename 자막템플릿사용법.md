# 자막 템플릿 시스템 사용법

## 개요
자막 템플릿 시스템은 다양한 shadowing 비디오 패턴을 JSON 설정 파일로 관리하여, 코드 수정 없이 새로운 학습 패턴을 추가할 수 있는 유연한 시스템입니다.

## 시스템 구조

### 1. 템플릿 설정 파일
- 위치: `templates/shadowing_patterns.json`
- 모든 shadowing 패턴을 정의하는 중앙 설정 파일

### 2. 주요 구성 요소
- **template_video_encoder.py**: 템플릿 기반 비디오 인코더
- **subtitle_generator.py**: 독립적인 자막 생성 컴포넌트
- **clipping_api.py**: API 엔드포인트

## 템플릿 구조

### 기본 템플릿 형식
```json
{
  "patterns": {
    "template_이름": {
      "name": "템플릿 표시 이름",
      "description": "템플릿 설명",
      "clips": [
        {
          "subtitle_mode": "자막 표시 방식",
          "folder_name": "저장 폴더명",
          "count": 반복 횟수,
          "subtitle_type": "사용할 자막 타입"
        }
      ],
      "gap_duration": 클립 간 간격(초)
    }
  }
}
```

### 필드 설명

#### subtitle_mode (자막 표시 방식)
- `no_subtitle`: 자막 없음
- `blank_subtitle`: 키워드 블랭크 처리 (영어만)
- `both_subtitle`: 영한 자막 모두 표시
- `full_subtitle`: 전체 자막 (키워드 강조 포함)
- `korean_only`: 한글 자막만 표시
- `blank_with_korean`: 영어 블랭크 + 한글 자막

#### subtitle_type (자막 파일 타입)
- `null`: 자막 파일 없음
- `blank`: 블랭크 처리된 자막 (영어만)
- `full`: 완전한 영한 자막
- `korean`: 한글만 있는 자막
- `blank_korean`: 영어 블랭크 + 한글 자막

#### folder_name (개별 클립 저장 폴더)
- 개별 클립들이 저장될 하위 폴더명
- 예: `1_nosub`, `2_blank`, `3_both`, `4_full`

## 기본 제공 템플릿

### Template 1: Progressive Learning (점진적 학습)
- **패턴**: 무자막 1회 → 블랭크 1회 → 블랭크+한글 1회 → 영한자막 1회 → 무자막 1회 (복습)
- **용도**: 완전한 단계별 학습 (총 5단계)
- **API 호출**: `template_number: 1`
- **특징**: 키워드가 있으면 블랭크 처리, 없으면 전체 텍스트 블랭크

### Template 2: Keyword Focus
- **패턴**: 무자막 1회 → 블랭크 1회 → 영한+키워드강조 2회
- **용도**: 핵심 단어 집중 학습
- **API 호출**: `template_number: 2`
- **필수**: keywords 배열 제공

### Template 3: Progressive Learning (기존)
- **패턴**: 무자막 2회 → 블랭크+한글 2회 → 영한자막 2회
- **용도**: 단계적 학습 (키워드 블랭크로 난이도 조절)
- **API 호출**: `template_number: 3`
- **특징**: 키워드 블랭크 처리

## 새로운 템플릿 추가하기

### 1단계: JSON에 템플릿 정의 추가
```json
"template_4": {
  "name": "Custom Pattern",
  "description": "사용자 정의 패턴",
  "clips": [
    {
      "subtitle_mode": "english_only",
      "folder_name": "1_eng",
      "count": 1,
      "subtitle_type": "english"
    }
  ],
  "gap_duration": 2.0
}
```

### 2단계: 새로운 subtitle_type 지원 (필요시)
`template_video_encoder.py`의 `_prepare_subtitle_files` 메서드에 추가:
```python
elif subtitle_type == 'english':
    # English only subtitle
    eng_ass = tempfile.NamedTemporaryFile(suffix='_english.ass', delete=False)
    eng_ass.close()
    self.subtitle_generator.generate_english_only_subtitle(subtitle_data, eng_ass.name)
    subtitle_files['english'] = eng_ass.name
```

### 3단계: 새로운 자막 생성 메서드 추가 (필요시)
`subtitle_generator.py`에 메서드 추가:
```python
def generate_english_only_subtitle(self, subtitle_data: Dict, output_path: str) -> bool:
    """영어만 있는 자막 생성"""
    try:
        subtitle = subtitle_data.copy()
        # 한글 제거
        subtitle['kor'] = ''
        subtitle['korean'] = ''
        # 노트 제거
        subtitle['note'] = ''
        
        self.ass_generator.generate_ass([subtitle], output_path)
        return True
    except Exception as e:
        print(f"Error generating English-only subtitle: {e}")
        return False
```

### 4단계: API validation 수정 (필요시)
새 템플릿 번호가 3을 초과하는 경우 `clipping_api.py` 수정:
```python
template_number: int = Field(1, ge=1, le=3, description="템플릿 번호 (1, 2, 또는 3)")
```

## API 사용 예제

### Template 1 (Progressive Learning - 5단계)
```json
{
  "media_path": "/path/to/video.mp4",
  "start_time": 10.0,
  "end_time": 15.0,
  "text_eng": "Hello, how are you?",
  "text_kor": "안녕하세요, 어떻게 지내세요?",
  "note": "인사말",
  "keywords": ["Hello", "how"],
  "template_number": 1
}
```

### Template 2 (Keyword Focus)
```json
{
  "media_path": "/path/to/video.mp4",
  "start_time": 20.0,
  "end_time": 25.0,
  "text_eng": "I love learning new languages",
  "text_kor": "나는 새로운 언어를 배우는 것을 좋아해요",
  "note": "언어 학습",
  "keywords": ["love", "learning", "languages"],
  "template_number": 2
}
```

### Template 3 (Progressive Learning)
```json
{
  "media_path": "/path/to/video.mp4",
  "start_time": 30.0,
  "end_time": 35.0,
  "text_eng": "Practice makes perfect",
  "text_kor": "연습이 완벽을 만든다",
  "note": "격언",
  "template_number": 3
}
```

## 출력 구조

생성된 파일은 다음과 같은 구조로 저장됩니다:

```
/mnt/ssd1t/output/
└── {job_id}/
    ├── output.mp4              # 최종 shadowing 비디오
    ├── metadata.json           # 작업 메타데이터
    └── individual_clips/       # 개별 클립 (선택사항)
        ├── 1_nosub/
        │   ├── clip_0001_1.mp4
        │   └── clip_0001_2.mp4
        ├── 2_blank/
        │   └── clip_0001_1.mp4
        └── 3_both/
            ├── clip_0001_1.mp4
            └── clip_0001_2.mp4
```

## 확장 가능성

이 시스템은 다음과 같은 확장이 가능합니다:

1. **새로운 자막 모드 추가**
   - 예: `highlighted` (특정 단어 강조)
   - 예: `slow_fade` (점진적 표시)

2. **새로운 자막 타입 추가**
   - 예: `phonetic` (발음 기호 포함)
   - 예: `translation_notes` (번역 노트 포함)

3. **동적 패턴 생성**
   - 사용자 레벨에 따른 자동 패턴 생성
   - AI 기반 최적 학습 패턴 추천

## 주요 개선사항 (최신)

### Template 1 개선
- **기존**: 무자막 2회 → 영한자막 2회 (4단계)
- **개선**: 무자막 → 블랭크 → 블랭크+한글 → 영한자막 → 무자막 복습 (5단계)
- **효과**: 더 체계적인 단계별 학습 가능

### 블랭크 자막 개선
- keywords가 없을 때 전체 텍스트를 블랭크 처리
- `text_eng_blank`가 `None`일 때 올바른 처리
- 더 정확한 키워드 블랭크 생성

### 정지화면 기능 (사용 가능)
- `video_mode: "still_frame"` 설정으로 정지화면 클립 생성
- 파일 크기 최적화 (90% 감소)
- FFmpeg 최적화 설정 유지

## 주의사항

1. 새로운 템플릿 추가 시 API의 `template_number` 범위 확인 필요 (현재 1-3)
2. 자막 파일 생성 로직이 복잡한 경우 `subtitle_generator.py`에 메서드 추가 필요
3. 템플릿 이름은 `template_숫자` 형식 권장 (API와의 매핑을 위해)

## 문제 해결

### 템플릿이 인식되지 않는 경우
1. JSON 문법 오류 확인
2. 템플릿 이름이 올바른지 확인
3. 서버 재시작 필요할 수 있음

### 자막이 제대로 생성되지 않는 경우
1. `subtitle_type`이 구현되어 있는지 확인
2. `subtitle_generator.py`에 해당 메서드가 있는지 확인
3. 로그에서 오류 메시지 확인