# ë¦¬ë·° í´ë¦½ ìƒì„± ë¬¸ì œ í•´ê²°ë°©ì•ˆ

## ğŸ“‹ ë¬¸ì œì  ìš”ì•½

### 1. í•µì‹¬ ë¬¸ì œë“¤
- **FFmpeg Concat DTS ì—ëŸ¬**: Non-monotonous DTSë¡œ ì¸í•œ íƒ€ì„ìŠ¤íƒ¬í”„ ë¶ˆì¼ì¹˜
- **ì˜¤ë””ì˜¤ ìŠ¤íŠ¸ë¦¼ ëˆ„ë½**: íƒ€ì´í‹€ í´ë¦½ì— ì˜¤ë””ì˜¤ íŠ¸ë™ ì—†ì–´ì„œ ì „ì²´ ì˜¤ë””ì˜¤ ì†ì‹¤
- **í•œê¸€ ìë§‰ ê¹¨ì§**: drawtext í•„í„° í…ìŠ¤íŠ¸ ì´ìŠ¤ì¼€ì´í”„ ë¬¸ì œ
- **API ì¬ì‹œì‘ ë¬¸ì œ**: ì½”ë“œ ë³€ê²½ í›„ gunicorn ì¬ë¡œë“œ ì‹¤íŒ¨

### 2. ì¦ìƒ
- ë¦¬ë·° í´ë¦½ì´ ìµœì¢… ë¹„ë””ì˜¤ì— í¬í•¨ë˜ì§€ ì•ŠìŒ
- ì „ì²´ ë¹„ë””ì˜¤ ê¸¸ì´ê°€ ì²« ë²ˆì§¸ í´ë¦½ë§Œí¼ë§Œ ë‚˜ì˜´
- ì˜¤ë””ì˜¤ê°€ ì „í˜€ ì¬ìƒë˜ì§€ ì•ŠìŒ
- í•œê¸€ ìë§‰ì´ ê¹¨ì ¸ì„œ í‘œì‹œë¨

## ğŸ”§ í•´ê²° ë°©ì•ˆ

### 1. Concat â†’ Filter_Complex êµì²´ (ìµœìš°ì„ )

#### í˜„ì¬ ë¬¸ì œ ì½”ë“œ (`review_clip_generator.py` 291-320ì¤„)
```python
# âŒ ë¬¸ì œ: concat demuxer ì‚¬ìš© (DTS ì—ëŸ¬ ë°œìƒ)
async def _concat_clips(self, clips: List[str], output_path: str) -> bool:
    concat_file = tempfile.NamedTemporaryFile(mode='w', suffix='.txt', delete=False)
    for clip in clips:
        concat_file.write(f"file '{clip}'\n")
    
    cmd = [
        'ffmpeg', '-y',
        '-f', 'concat', '-safe', '0', '-i', concat_file.name,
        '-c:v', 'libx264', '-c:a', 'aac',
        output_path
    ]
```

#### í•´ê²° ì½”ë“œ
```python
# âœ… í•´ê²°: filter_complex ì‚¬ìš© (ì•ˆì •ì  ë³‘í•©)
async def _concat_clips_fixed(self, clips: List[str], output_path: str) -> bool:
    """Filter_complexë¥¼ ì‚¬ìš©í•œ ì•ˆì •ì  í´ë¦½ ë³‘í•©"""
    try:
        if len(clips) == 1:
            # ë‹¨ì¼ í´ë¦½ì¸ ê²½ìš° ë³µì‚¬ë§Œ
            cmd = ['ffmpeg', '-y', '-i', clips[0], '-c', 'copy', output_path]
        else:
            # ë‹¤ì¤‘ í´ë¦½ filter_complex ë³‘í•©
            inputs = []
            for clip in clips:
                inputs.extend(['-i', clip])
            
            # filter_complex êµ¬ì„±
            video_inputs = ''.join([f'[{i}:v]' for i in range(len(clips))])
            audio_inputs = ''.join([f'[{i}:a]' for i in range(len(clips))])
            filter_complex = f"{video_inputs}{audio_inputs}concat=n={len(clips)}:v=1:a=1[outv][outa]"
            
            cmd = [
                'ffmpeg', '-y'
            ] + inputs + [
                '-filter_complex', filter_complex,
                '-map', '[outv]', '-map', '[outa]',
                '-c:v', 'libx264', '-preset', 'medium', '-crf', '16',
                '-c:a', 'aac', '-b:a', '192k', '-ar', '44100', '-ac', '2',
                output_path
            ]
        
        result = subprocess.run(cmd, capture_output=True, text=True)
        
        if result.returncode != 0:
            logger.error(f"FFmpeg concat error: {result.stderr}")
            return False
            
        logger.info(f"Successfully concatenated {len(clips)} clips")
        return True
        
    except Exception as e:
        logger.error(f"Error concatenating clips: {e}")
        return False
```

### 2. ì˜¤ë””ì˜¤ íŠ¸ë™ ë³´ì¥

#### íƒ€ì´í‹€ í´ë¦½ ìƒì„± ìˆ˜ì • (`review_clip_generator.py` 194-288ì¤„)
```python
# âœ… ëª¨ë“  í´ë¦½ì— ì˜¤ë””ì˜¤ íŠ¸ë™ ë³´ì¥
async def _create_title_clip(self, output_path: str, title: str, width: int, height: int) -> bool:
    """íƒ€ì´í‹€ í´ë¦½ ìƒì„± (ì˜¤ë””ì˜¤ íŠ¸ë™ í¬í•¨)"""
    try:
        drawtext_filter = self._create_drawtext_filter(title, width, height)
        
        cmd = [
            'ffmpeg', '-y',
            # ë¹„ë””ì˜¤ ì…ë ¥ (ê²€ì€ ë°°ê²½)
            '-f', 'lavfi', '-i', f'color=c=black:s={width}x{height}:d=2',
            # ì˜¤ë””ì˜¤ ì…ë ¥ (ë¬´ìŒ)
            '-f', 'lavfi', '-i', 'anullsrc=channel_layout=stereo:sample_rate=44100',
            '-vf', drawtext_filter,
            '-c:v', 'libx264', '-preset', 'medium', '-crf', '16',
            '-c:a', 'aac', '-b:a', '192k', '-ar', '44100', '-ac', '2',
            '-shortest',  # ê°€ì¥ ì§§ì€ ìŠ¤íŠ¸ë¦¼ì— ë§ì¶¤
            output_path
        ]
        
        result = subprocess.run(cmd, capture_output=True, text=True)
        return result.returncode == 0
        
    except Exception as e:
        logger.error(f"Error creating title clip: {e}")
        return False
```

### 3. í•œê¸€ ìë§‰ ì´ìŠ¤ì¼€ì´í”„ ê°œì„ 

#### drawtext í•„í„° ê°œì„  (`review_clip_generator.py` 147-175ì¤„)
```python
def _create_drawtext_filter(self, text: str, width: int, height: int) -> str:
    """ê°œì„ ëœ drawtext í•„í„° ìƒì„± (í•œê¸€ ì§€ì›)"""
    
    # í…ìŠ¤íŠ¸ ì´ìŠ¤ì¼€ì´í”„ í•¨ìˆ˜
    def escape_drawtext(text: str) -> str:
        """drawtextìš© ì•ˆì „í•œ í…ìŠ¤íŠ¸ ì´ìŠ¤ì¼€ì´í”„"""
        return (text.replace('\\', '\\\\')
                   .replace(':', '\\:')
                   .replace("'", "\\'")
                   .replace('"', '\\"')
                   .replace('%', '\\%'))
    
    # í°íŠ¸ ì„¤ì •
    font_path = "/home/kang/dev_amd/shadowing_maker_xls/font/TmonMonsori.ttf"
    if not os.path.exists(font_path):
        font_path = "/usr/share/fonts/truetype/noto/NotoSansCJK-Bold.ttc"
    
    escaped_text = escape_drawtext(text)
    font_size = 42 if width == 1080 else 32  # ì‡¼ì¸ ìš© í¬ê²Œ
    
    return (f"drawtext=fontfile='{font_path}'"
            f":text='{escaped_text}'"
            f":fontsize={font_size}"
            f":fontcolor=white"
            f":borderw=2"
            f":bordercolor=black"
            f":x=(w-text_w)/2"
            f":y=(h-text_h)/2")
```

### 4. ê°œë³„ í´ë¦½ ìƒì„± ê°œì„ 

#### TTS í´ë¦½ ìƒì„± ì•ˆì •í™”
```python
async def _create_individual_clip(self, tts_file: str, korean_text: str, 
                                 output_path: str, width: int, height: int) -> bool:
    """ê°œë³„ TTS í´ë¦½ ìƒì„± (ì˜¤ë””ì˜¤ ë™ê¸°í™” ë³´ì¥)"""
    try:
        # TTS ì˜¤ë””ì˜¤ ê¸¸ì´ í™•ì¸
        probe_cmd = [
            'ffprobe', '-v', 'error', '-show_entries', 'format=duration',
            '-of', 'default=noprint_wrappers=1:nokey=1', tts_file
        ]
        result = subprocess.run(probe_cmd, capture_output=True, text=True)
        duration = float(result.stdout.strip())
        
        # í•œê¸€ ìë§‰ í•„í„°
        drawtext_filter = self._create_drawtext_filter(korean_text, width, height)
        
        cmd = [
            'ffmpeg', '-y',
            # ë¹„ë””ì˜¤ ì…ë ¥ (ê²€ì€ ë°°ê²½, TTS ê¸¸ì´ë§Œí¼)
            '-f', 'lavfi', '-i', f'color=c=black:s={width}x{height}:d={duration}',
            # ì˜¤ë””ì˜¤ ì…ë ¥ (TTS)
            '-i', tts_file,
            '-vf', drawtext_filter,
            '-c:v', 'libx264', '-preset', 'medium', '-crf', '16',
            '-c:a', 'aac', '-b:a', '192k', '-ar', '44100', '-ac', '2',
            '-shortest',
            output_path
        ]
        
        result = subprocess.run(cmd, capture_output=True, text=True)
        
        if result.returncode != 0:
            logger.error(f"Individual clip creation failed: {result.stderr}")
            return False
            
        logger.info(f"Created individual clip: {output_path} (duration: {duration:.2f}s)")
        return True
        
    except Exception as e:
        logger.error(f"Error creating individual clip: {e}")
        return False
```

## ğŸš€ êµ¬í˜„ ë‹¨ê³„

### 1ë‹¨ê³„: _concat_clips ë©”ì„œë“œ êµì²´
1. `review_clip_generator.py`ì˜ 291-320ì¤„ êµì²´
2. filter_complex ë°©ì‹ìœ¼ë¡œ êµ¬í˜„

### 2ë‹¨ê³„: ì˜¤ë””ì˜¤ íŠ¸ë™ ë³´ì¥
1. íƒ€ì´í‹€ í´ë¦½ì— ë¬´ìŒ ì˜¤ë””ì˜¤ ì¶”ê°€
2. ëª¨ë“  ê°œë³„ í´ë¦½ì— ì˜¤ë””ì˜¤ ìŠ¤íŠ¸ë¦¼ í™•ì¸

### 3ë‹¨ê³„: í•œê¸€ ìë§‰ ê°œì„ 
1. drawtext ì´ìŠ¤ì¼€ì´í”„ í•¨ìˆ˜ ê°œì„ 
2. í°íŠ¸ ê²½ë¡œ í™•ì¸ ë¡œì§ ì¶”ê°€

### 4ë‹¨ê³„: API ì¬ì‹œì‘ í”„ë¡œì„¸ìŠ¤ ê°œì„ 
```bash
# ì™„ì „ ì¬ì‹œì‘ ìŠ¤í¬ë¦½íŠ¸
#!/bin/bash
echo "Stopping API server..."
pkill -f "gunicorn.*clipping_api"
sleep 2
echo "Starting API server..."
cd /home/kang/dev_amd/shadowing_maker_xls
source venv/bin/activate
gunicorn -w 4 -k uvicorn.workers.UvicornWorker clipping_api:app --bind 0.0.0.0:8081 --daemon
echo "API server restarted"
```

## ğŸ§ª í…ŒìŠ¤íŠ¸ ë°©ë²•

### 1. ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
```python
# test_review_fixed.py
import asyncio
from review_clip_generator import ReviewClipGenerator

async def test_fixed_review():
    generator = ReviewClipGenerator()
    clips_data = [
        {"text_eng": "You will be Hunters.", "text_kor": "ë„ˆí¬ëŠ” í—Œí„°ê°€ ë  ê±°ì•¼"}
    ]
    
    success = await generator.create_review_clip(
        clips_data, "test_fixed_output.mp4", "ìŠ¤í”¼ë“œ ë³µìŠµ", 11
    )
    
    if success:
        print("âœ… Fixed review clip creation successful")
        # ë¹„ë””ì˜¤ ì •ë³´ í™•ì¸
        import subprocess
        result = subprocess.run([
            'ffprobe', '-v', 'error', '-show_streams', 'test_fixed_output.mp4'
        ], capture_output=True, text=True)
        print("Stream info:", result.stdout)
    else:
        print("âŒ Fixed review clip creation failed")

if __name__ == "__main__":
    asyncio.run(test_fixed_review())
```

### 2. API í…ŒìŠ¤íŠ¸
```bash
curl -X POST http://localhost:8081/api/clip/batch \
  -H "Content-Type: application/json" \
  -d '{
    "media_path": "/mnt/qnap/media_eng/indexed_media/Animation/KPop.Demon.Hunters.2025.1080p.WEBRip.x264.AAC5.1-[YTS.MX].mp4",
    "clips": [
        {
            "start_time": 52.127,
            "end_time": 55.187999999999995,
            "text_eng": "You will be Hunters.",
            "text_kor": "ë„ˆí¬ëŠ” í—Œí„°ê°€ ë  ê±°ì•¼",
            "keywords": []
        }
    ],
    "study": "review",
    "template_number": 11,
    "title_1": "í…ŒìŠ¤íŠ¸",
    "title_2": "ìˆ˜ì •ë¨"
}'
```

### 3. ê²°ê³¼ ê²€ì¦
```bash
# ìƒì„±ëœ íŒŒì¼ í™•ì¸
ffprobe -v error -show_streams combined.mp4 | grep codec_type
# ì˜ˆìƒ ê²°ê³¼: video, audio ë‘˜ ë‹¤ ì¡´ì¬

# ë¹„ë””ì˜¤ ê¸¸ì´ í™•ì¸
ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 combined.mp4
# ì˜ˆìƒ ê²°ê³¼: ì›ë³¸ í´ë¦½ + ë¦¬ë·° í´ë¦½ ê¸¸ì´ í•©ê³„

# ì˜¤ë””ì˜¤ ì¬ìƒ í…ŒìŠ¤íŠ¸
ffplay combined.mp4  # ì˜¤ë””ì˜¤ê°€ ì •ìƒ ì¬ìƒë˜ëŠ”ì§€ í™•ì¸
```

## ğŸ“ˆ ê¸°ëŒ€ íš¨ê³¼

1. **DTS ì—ëŸ¬ ì™„ì „ í•´ê²°**: filter_complex ì‚¬ìš©ìœ¼ë¡œ íƒ€ì„ìŠ¤íƒ¬í”„ ë¬¸ì œ í•´ê²°
2. **ì˜¤ë””ì˜¤ ë³´ì¡´**: ëª¨ë“  í´ë¦½ì— ì˜¤ë””ì˜¤ íŠ¸ë™ ë³´ì¥ìœ¼ë¡œ ìµœì¢… ë¹„ë””ì˜¤ì—ì„œ ì˜¤ë””ì˜¤ ì¬ìƒ
3. **í•œê¸€ ìë§‰ ì •ìƒ í‘œì‹œ**: ê°œì„ ëœ ì´ìŠ¤ì¼€ì´í”„ë¡œ í•œê¸€ ê¹¨ì§ í•´ê²°
4. **ì•ˆì •ì  ë³‘í•©**: ëª¨ë“  í´ë¦½ì´ ìµœì¢… ë¹„ë””ì˜¤ì— í¬í•¨ë¨

## âš ï¸ ì£¼ì˜ì‚¬í•­

1. **ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ì¦ê°€**: filter_complexëŠ” concatë³´ë‹¤ ë©”ëª¨ë¦¬ë¥¼ ë” ì‚¬ìš©
2. **ì²˜ë¦¬ ì‹œê°„ ì¦ê°€**: ì¬ì¸ì½”ë”©ìœ¼ë¡œ ì¸í•œ ì²˜ë¦¬ ì‹œê°„ ì¦ê°€
3. **í°íŠ¸ íŒŒì¼ í™•ì¸**: í•œê¸€ í°íŠ¸ íŒŒì¼ ì¡´ì¬ ì—¬ë¶€ ë°˜ë“œì‹œ í™•ì¸

## ğŸ”„ ë°°í¬ ì ˆì°¨

1. **ë°±ì—… ìƒì„±**: í˜„ì¬ `review_clip_generator.py` ë°±ì—…
2. **ì½”ë“œ ìˆ˜ì •**: ìœ„ì˜ í•´ê²° ì½”ë“œë¡œ êµì²´
3. **API ì¬ì‹œì‘**: ì™„ì „ ì¬ì‹œì‘ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
4. **í…ŒìŠ¤íŠ¸ ì‹¤í–‰**: ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ë° API í…ŒìŠ¤íŠ¸
5. **ê²°ê³¼ ê²€ì¦**: ë¹„ë””ì˜¤ íŒŒì¼ í’ˆì§ˆ í™•ì¸

## ğŸ“ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [x] `_concat_clips` ë©”ì„œë“œë¥¼ filter_complex ë°©ì‹ìœ¼ë¡œ êµì²´
- [x] íƒ€ì´í‹€ í´ë¦½ì— ë¬´ìŒ ì˜¤ë””ì˜¤ íŠ¸ë™ ì¶”ê°€
- [x] drawtext ì´ìŠ¤ì¼€ì´í”„ í•¨ìˆ˜ ê°œì„ 
- [x] í°íŠ¸ íŒŒì¼ ê²½ë¡œ í™•ì¸ ë¡œì§ ì¶”ê°€
- [ ] API ì¬ì‹œì‘ ìŠ¤í¬ë¦½íŠ¸ ì‘ì„±
- [x] ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‘ì„± ë° ì‹¤í–‰
- [x] API í†µí•© í…ŒìŠ¤íŠ¸ ì‹¤í–‰
- [x] ê²°ê³¼ ë¹„ë””ì˜¤ í’ˆì§ˆ ê²€ì¦

## ğŸ“Š êµ¬í˜„ ê²°ê³¼

### âœ… ì„±ê³µí•œ ë¶€ë¶„

1. **review_clip_generator.py ê°œì„ **
   - filter_complexë¥¼ ì‚¬ìš©í•œ `_concat_clips` ë©”ì„œë“œ êµ¬í˜„ ì™„ë£Œ
   - drawtext ì´ìŠ¤ì¼€ì´í”„ í•¨ìˆ˜ ê°œì„ ìœ¼ë¡œ íŠ¹ìˆ˜ë¬¸ì ì²˜ë¦¬ ê°•í™”
   - í…Œë‘ë¦¬(borderw) ì¶”ê°€ë¡œ ìë§‰ ê°€ë…ì„± í–¥ìƒ

2. **ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì„±ê³µ**
   ```
   âœ… Review clip created successfully: test_fixed_output.mp4
   ğŸ“Š Video analysis:
     Video stream: âœ… (h264)
     Audio stream: âœ… (aac)
     Duration: 4.44 seconds
     File size: 59.5 KB
   
   âœ… Multiple clips review created: test_multiple_clips.mp4
     Total duration: 8.13 seconds
   ```

3. **ê°œë³„ ë¦¬ë·° í´ë¦½ ìƒì„± ì •ìƒ ì‘ë™**
   - TTS ì˜¤ë””ì˜¤ í¬í•¨ í™•ì¸
   - íƒ€ì´í‹€ í´ë¦½ì— ë¬´ìŒ ì˜¤ë””ì˜¤ ì¶”ê°€ë¨
   - í•œê¸€ ìë§‰ ì •ìƒ í‘œì‹œ

### âš ï¸ ë¯¸í•´ê²° ì´ìŠˆ

1. **API í†µí•© ì‹œ ë¬¸ì œ**
   - clipping_api.pyì˜ filter_complex ì½”ë“œê°€ ì œëŒ€ë¡œ ì‘ë™í•˜ì§€ ì•ŠìŒ
   - ìµœì¢… combined ë¹„ë””ì˜¤ ìƒì„± ì‹œ "moov atom not found" ì—ëŸ¬ ë°œìƒ
   - API ì¬ì‹œì‘ì´ ì™„ì „í•˜ì§€ ì•Šì•„ ì½”ë“œ ë³€ê²½ì‚¬í•­ì´ ì¦‰ì‹œ ë°˜ì˜ë˜ì§€ ì•ŠìŒ

2. **ë¡œê·¸ ë©”ì‹œì§€ ë¶ˆì¼ì¹˜**
   - ì‹¤ì œë¡œëŠ” filter_complexë¥¼ ì‚¬ìš©í•˜ì§€ë§Œ ë¡œê·¸ì—ëŠ” ì—¬ì „íˆ "concat" ë©”ì‹œì§€ ì¶œë ¥

### ğŸ” ì¶”ê°€ ë””ë²„ê¹… í•„ìš”

1. clipping_api.pyì˜ filter_complex êµ¬í˜„ ê²€ì¦
2. API ì™„ì „ ì¬ì‹œì‘ ë°©ë²• í™•ë¦½
3. ì—ëŸ¬ ë¡œê¹… ê°œì„ ìœ¼ë¡œ ì •í™•í•œ ë¬¸ì œ íŒŒì•…
