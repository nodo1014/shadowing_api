<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Clipping Admin</title>
    <link rel="stylesheet" href="frontend/css/styles.css">
    <style>
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 24px;
        }
        
        .stat-card {
            background: white;
            padding: 16px;
            border-radius: 6px;
            border: 1px solid var(--gray-200);
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 600;
            color: var(--gray-900);
            margin: 4px 0;
        }
        
        .stat-label {
            color: var(--gray-500);
            font-size: 12px;
        }
        
        /* Filters */
        .filters {
            background: white;
            padding: 16px;
            border-radius: 6px;
            border: 1px solid var(--gray-200);
            margin-bottom: 24px;
        }
        
        .filters h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
        }
        
        .filter-row {
            display: flex;
            gap: 12px;
            align-items: end;
            flex-wrap: wrap;
        }
        
        /* Table */
        .jobs-table {
            background: white;
            border-radius: 6px;
            border: 1px solid var(--gray-200);
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        
        th {
            background: var(--gray-50);
            padding: 12px;
            text-align: left;
            font-weight: 500;
            color: var(--gray-700);
            border-bottom: 1px solid var(--gray-200);
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid var(--gray-100);
        }
        
        tr:hover {
            background: var(--gray-50);
        }
        
        /* Action Buttons */
        .action-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 4px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            margin-right: 4px;
        }
        
        .action-btn:hover {
            background: var(--primary-hover);
        }
        
        .action-btn.download {
            background: var(--success);
        }
        
        .action-btn.download:hover {
            opacity: 0.9;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            padding: 24px;
            border-radius: 6px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            margin: 20px;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .modal-header h2 {
            font-size: 18px;
            font-weight: 600;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--gray-400);
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .close-modal:hover {
            color: var(--gray-600);
        }
        
        .info-group {
            margin-bottom: 16px;
        }
        
        .info-group h4 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--gray-700);
        }
        
        .info-item {
            display: flex;
            padding: 4px 0;
            font-size: 13px;
        }
        
        .info-label {
            font-weight: 500;
            color: var(--gray-600);
            width: 120px;
            flex-shrink: 0;
        }
        
        .info-value {
            color: var(--gray-800);
        }
        
        .text-preview {
            background: var(--gray-50);
            padding: 12px;
            border-radius: 4px;
            margin: 8px 0;
            white-space: pre-wrap;
            font-size: 13px;
            border: 1px solid var(--gray-200);
        }
        
        .keyword-highlight {
            background: #fef3c7;
            padding: 2px 4px;
            border-radius: 2px;
        }
        
        /* Bulk Actions */
        .bulk-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .delete-btn {
            background: var(--danger);
            color: white;
        }
        
        .delete-btn:hover {
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>Video Clipping Admin</h1>
            <p>í´ë¦¬í•‘ ì‘ì—… ê´€ë¦¬ ë° í†µê³„</p>
            <div style="margin-top: 10px;">
                <a href="/" style="margin-right: 10px; color: #007bff;">â† ë©”ì¸ìœ¼ë¡œ</a>
                <a href="/viewer/" style="color: #007bff;">ğŸ“º ìœ íŠœë¸Œ ë·°ì–´</a>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- í†µê³„ -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">ì „ì²´ ì‘ì—…</div>
                <div class="stat-value" id="total-jobs">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ì™„ë£Œ</div>
                <div class="stat-value" id="completed-jobs">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ì„±ê³µë¥ </div>
                <div class="stat-value" id="success-rate">0%</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ì²˜ë¦¬ ì‹œê°„</div>
                <div class="stat-value" id="total-duration">0h</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ìš©ëŸ‰</div>
                <div class="stat-value" id="total-size">0MB</div>
            </div>
        </div>

        <!-- í•„í„° -->
        <div class="filters">
            <h3>ê²€ìƒ‰ í•„í„°</h3>
            <div class="filter-row">
                <div class="form-group">
                    <label>í‚¤ì›Œë“œ</label>
                    <input type="text" id="search-keyword" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥">
                </div>
                <div class="form-group">
                    <label>ìƒíƒœ</label>
                    <select id="search-status">
                        <option value="">ì „ì²´</option>
                        <option value="pending">ëŒ€ê¸°ì¤‘</option>
                        <option value="processing">ì²˜ë¦¬ì¤‘</option>
                        <option value="completed">ì™„ë£Œ</option>
                        <option value="failed">ì‹¤íŒ¨</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ì‹œì‘ì¼</label>
                    <input type="date" id="search-start-date">
                </div>
                <div class="form-group">
                    <label>ì¢…ë£Œì¼</label>
                    <input type="date" id="search-end-date">
                </div>
                <button class="submit-btn" onclick="searchJobs()">ê²€ìƒ‰</button>
                <button class="cancel-btn" onclick="resetFilters()">ì´ˆê¸°í™”</button>
            </div>
        </div>

        <!-- ì¼ê´„ ì‘ì—… & ë³´ê¸° ì „í™˜ -->
        <div class="bulk-actions">
            <button class="action-btn delete-btn" onclick="deleteSelected()">ì„ íƒ ì‚­ì œ</button>
            <button class="action-btn" onclick="cleanupOldJobs()">30ì¼ ì´ìƒ ì •ë¦¬</button>
            <div class="view-toggle">
                <button class="view-btn active" id="grid-view-btn" onclick="switchView('grid')">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                        <rect x="1" y="1" width="6" height="6" rx="1"/>
                        <rect x="9" y="1" width="6" height="6" rx="1"/>
                        <rect x="1" y="9" width="6" height="6" rx="1"/>
                        <rect x="9" y="9" width="6" height="6" rx="1"/>
                    </svg>
                    ê·¸ë¦¬ë“œ
                </button>
                <button class="view-btn" id="list-view-btn" onclick="switchView('list')">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                        <rect x="1" y="2" width="14" height="2" rx="1"/>
                        <rect x="1" y="7" width="14" height="2" rx="1"/>
                        <rect x="1" y="12" width="14" height="2" rx="1"/>
                    </svg>
                    ë¦¬ìŠ¤íŠ¸
                </button>
            </div>
        </div>

        <!-- ê·¸ë¦¬ë“œ ë·° -->
        <div class="jobs-grid" id="jobs-grid" style="display: none;">
            <!-- Grid items will be dynamically added here -->
        </div>

        <!-- ì‘ì—… ëª©ë¡ -->
        <div class="jobs-table" id="jobs-table">
            <table>
                <thead>
                    <tr>
                        <th width="30"><input type="checkbox" id="select-all" onchange="toggleSelectAll()"></th>
                        <th>ID</th>
                        <th>ìƒì„±ì¼ì‹œ</th>
                        <th>ë¯¸ë””ì–´</th>
                        <th>êµ¬ê°„</th>
                        <th>íƒ€ì…</th>
                        <th>ìƒíƒœ</th>
                        <th>í¬ê¸°</th>
                        <th>ì‘ì—…</th>
                    </tr>
                </thead>
                <tbody id="jobs-tbody">
                    <!-- ë™ì ìœ¼ë¡œ ì¶”ê°€ë¨ -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- ìƒì„¸ ì •ë³´ ëª¨ë‹¬ -->
    <div id="detail-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>í´ë¦½ ìƒì„¸ ì •ë³´</h2>
                <button class="close-modal" onclick="closeModal()">&times;</button>
            </div>
            <div id="modal-body">
                <!-- ë™ì ìœ¼ë¡œ ì¶”ê°€ë¨ -->
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = window.location.origin;
        let selectedJobs = new Set();
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            loadStatistics();
            loadRecentJobs();
        });
        
        // í†µê³„ ë¡œë“œ
        async function loadStatistics() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/statistics`);
                if (response.ok) {
                    const stats = await response.json();
                    document.getElementById('total-jobs').textContent = stats.total_jobs;
                    document.getElementById('completed-jobs').textContent = stats.completed_jobs;
                    document.getElementById('success-rate').textContent = stats.success_rate.toFixed(1) + '%';
                    document.getElementById('total-duration').textContent = formatDuration(stats.total_duration_seconds);
                    document.getElementById('total-size').textContent = formatSize(stats.total_output_size_mb);
                }
            } catch (error) {
                console.error('Failed to load statistics:', error);
            }
        }
        
        // ìµœê·¼ ì‘ì—… ë¡œë“œ
        async function loadRecentJobs() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/jobs/recent?limit=50`);
                if (response.ok) {
                    const jobs = await response.json();
                    displayJobs(jobs);
                }
            } catch (error) {
                console.error('Failed to load jobs:', error);
            }
        }
        
        // ë·° ì „í™˜ í•¨ìˆ˜
        function switchView(view) {
            if (typeof window.switchView === 'function') {
                window.switchView(view);
            }
        }
        
        // ì‘ì—… ê²€ìƒ‰
        async function searchJobs() {
            const params = new URLSearchParams();
            
            const keyword = document.getElementById('search-keyword').value;
            if (keyword) params.append('keyword', keyword);
            
            const status = document.getElementById('search-status').value;
            if (status) params.append('status', status);
            
            const startDate = document.getElementById('search-start-date').value;
            if (startDate) params.append('start_date', startDate);
            
            const endDate = document.getElementById('search-end-date').value;
            if (endDate) params.append('end_date', endDate);
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/jobs/search?${params}`);
                if (response.ok) {
                    const jobs = await response.json();
                    displayJobs(jobs);
                }
            } catch (error) {
                console.error('Search failed:', error);
            }
        }
        
        // í•„í„° ì´ˆê¸°í™”
        function resetFilters() {
            document.getElementById('search-keyword').value = '';
            document.getElementById('search-status').value = '';
            document.getElementById('search-start-date').value = '';
            document.getElementById('search-end-date').value = '';
            loadRecentJobs();
        }
        
        // ì‘ì—… ëª©ë¡ í‘œì‹œ
        function displayJobs(jobs) {
            const tbody = document.getElementById('jobs-tbody');
            tbody.innerHTML = '';
            selectedJobs.clear();
            document.getElementById('select-all').checked = false;
            
            jobs.forEach(job => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><input type="checkbox" value="${job.id}" onchange="toggleSelection('${job.id}')"></td>
                    <td title="${job.id}">${job.id.substring(0, 8)}...</td>
                    <td>${new Date(job.created_at).toLocaleString('ko-KR')}</td>
                    <td title="${job.media_path}">${job.media_filename || 'N/A'}</td>
                    <td>${job.start_time?.toFixed(1)}s - ${job.end_time?.toFixed(1)}s</td>
                    <td>Type ${job.clipping_type}</td>
                    <td><span class="status-badge ${job.status}">${getStatusText(job.status)}</span></td>
                    <td>${job.output_size ? formatSize(job.output_size / 1024 / 1024) : '-'}</td>
                    <td>
                        <button class="action-btn" onclick="showJobDetail('${job.id}')">ìƒì„¸</button>
                        ${job.status === 'completed' ? 
                            `<button class="action-btn download" onclick="downloadClip('${job.id}')">ë‹¤ìš´ë¡œë“œ</button>` : ''}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        // ì„ íƒ í† ê¸€
        function toggleSelection(jobId) {
            if (selectedJobs.has(jobId)) {
                selectedJobs.delete(jobId);
            } else {
                selectedJobs.add(jobId);
            }
        }
        
        // ì „ì²´ ì„ íƒ
        function toggleSelectAll() {
            const selectAll = document.getElementById('select-all').checked;
            const checkboxes = document.querySelectorAll('#jobs-tbody input[type="checkbox"]');
            
            checkboxes.forEach(cb => {
                cb.checked = selectAll;
                if (selectAll) {
                    selectedJobs.add(cb.value);
                } else {
                    selectedJobs.delete(cb.value);
                }
            });
        }
        
        // ì„ íƒ ì‚­ì œ
        async function deleteSelected() {
            if (selectedJobs.size === 0) {
                alert('ì‚­ì œí•  ì‘ì—…ì„ ì„ íƒí•˜ì„¸ìš”.');
                return;
            }
            
            if (!confirm(`${selectedJobs.size}ê°œì˜ ì‘ì—…ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/jobs`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        job_ids: Array.from(selectedJobs),
                        delete_files: true
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert(`${result.deleted_count}ê°œì˜ ì‘ì—…ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    loadRecentJobs();
                    loadStatistics();
                }
            } catch (error) {
                console.error('Delete failed:', error);
                alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
        
        // ì˜¤ë˜ëœ ì‘ì—… ì •ë¦¬
        async function cleanupOldJobs() {
            if (!confirm('30ì¼ ì´ìƒ ëœ ì‘ì—…ì„ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/cleanup`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        days_old: 30,
                        delete_files: true
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert(`${result.deleted_count}ê°œì˜ ì˜¤ë˜ëœ ì‘ì—…ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    loadRecentJobs();
                    loadStatistics();
                }
            } catch (error) {
                console.error('Cleanup failed:', error);
                alert('ì •ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
        
        // ì‘ì—… ìƒì„¸ ì •ë³´ í‘œì‹œ
        async function showJobDetail(jobId) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/jobs/${jobId}`);
                if (response.ok) {
                    const job = await response.json();
                    
                    const modalBody = document.getElementById('modal-body');
                    modalBody.innerHTML = `
                        <div class="info-group">
                            <h4>ê¸°ë³¸ ì •ë³´</h4>
                            <div class="info-item">
                                <span class="info-label">Job ID:</span>
                                <span class="info-value">${job.id}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">ìƒì„±ì¼ì‹œ:</span>
                                <span class="info-value">${new Date(job.created_at).toLocaleString('ko-KR')}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">ìƒíƒœ:</span>
                                <span class="info-value"><span class="status-badge ${job.status}">${getStatusText(job.status)}</span></span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">ì§„í–‰ë¥ :</span>
                                <span class="info-value">${job.progress}%</span>
                            </div>
                            ${job.error_message ? `
                            <div class="info-item">
                                <span class="info-label">ì—ëŸ¬:</span>
                                <span class="info-value" style="color: var(--danger)">${job.error_message}</span>
                            </div>` : ''}
                        </div>
                        
                        <div class="info-group">
                            <h4>ë¯¸ë””ì–´ ì •ë³´</h4>
                            <div class="info-item">
                                <span class="info-label">íŒŒì¼:</span>
                                <span class="info-value">${job.media_filename}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">êµ¬ê°„:</span>
                                <span class="info-value">${job.start_time}s - ${job.end_time}s (${job.duration}s)</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">íƒ€ì…:</span>
                                <span class="info-value">Type ${job.clipping_type}</span>
                            </div>
                        </div>
                        
                        <div class="info-group">
                            <h4>ìë§‰ ì •ë³´</h4>
                            <div class="text-preview">
                                <strong>ì˜ì–´:</strong><br>
                                ${highlightKeywords(job.text_eng || '', job.keywords)}
                            </div>
                            <div class="text-preview">
                                <strong>í•œêµ­ì–´:</strong><br>
                                ${job.text_kor || ''}
                            </div>
                            ${job.note ? `
                            <div class="text-preview">
                                <strong>ë…¸íŠ¸:</strong><br>
                                ${job.note}
                            </div>` : ''}
                            ${job.keywords && job.keywords.length > 0 ? `
                            <div class="info-item">
                                <span class="info-label">í‚¤ì›Œë“œ:</span>
                                <span class="info-value">${job.keywords.join(', ')}</span>
                            </div>` : ''}
                        </div>
                        
                        ${job.output_file ? `
                        <div class="info-group">
                            <h4>ì¶œë ¥ ì •ë³´</h4>
                            <div class="info-item">
                                <span class="info-label">íŒŒì¼ í¬ê¸°:</span>
                                <span class="info-value">${formatSize(job.output_size / 1024 / 1024)}</span>
                            </div>
                        </div>` : ''}
                    `;
                    
                    document.getElementById('detail-modal').style.display = 'flex';
                }
            } catch (error) {
                console.error('Failed to load job detail:', error);
            }
        }
        
        // ëª¨ë‹¬ ë‹«ê¸°
        function closeModal() {
            document.getElementById('detail-modal').style.display = 'none';
        }
        
        // í´ë¦½ ë‹¤ìš´ë¡œë“œ
        function downloadClip(jobId) {
            window.open(`${API_BASE_URL}/api/download/${jobId}`, '_blank');
        }
        
        // í—¬í¼ í•¨ìˆ˜ë“¤
        function getStatusText(status) {
            const statusMap = {
                'pending': 'ëŒ€ê¸°ì¤‘',
                'processing': 'ì²˜ë¦¬ì¤‘',
                'completed': 'ì™„ë£Œ',
                'failed': 'ì‹¤íŒ¨'
            };
            return statusMap[status] || status;
        }
        
        function formatDuration(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            if (hours > 0) {
                return `${hours}h ${minutes}m`;
            }
            return `${minutes}m`;
        }
        
        function formatSize(mb) {
            if (mb < 1) {
                return (mb * 1024).toFixed(0) + 'KB';
            } else if (mb < 1024) {
                return mb.toFixed(1) + 'MB';
            } else {
                return (mb / 1024).toFixed(1) + 'GB';
            }
        }
        
        function highlightKeywords(text, keywords) {
            if (!keywords || keywords.length === 0 || !text) return text;
            
            let highlighted = text;
            keywords.forEach(keyword => {
                const regex = new RegExp(`(${keyword})`, 'gi');
                highlighted = highlighted.replace(regex, '<span class="keyword-highlight">$1</span>');
            });
            return highlighted;
        }
        
        // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
            }
        });
        
        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        document.getElementById('detail-modal').addEventListener('click', (e) => {
            if (e.target.id === 'detail-modal') {
                closeModal();
            }
        });
    </script>
</body>
</html>