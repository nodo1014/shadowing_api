# 리뷰 클립 생성 문제 상세 기록

## 1. 현재 상황

### 1.1 API 요청 (실제 사용자가 보낸 JSON)
```json
{
    "media_path": "/mnt/qnap/media_eng/indexed_media/Animation/KPop.Demon.Hunters.2025.1080p.WEBRip.x264.AAC5.1-[YTS.MX].mp4",
    "clips": [
        {
            "start_time": 52.127,
            "end_time": 55.187999999999995,
            "text_eng": "You will be Hunters.",
            "text_kor": "너희는 헌터가 될 거야",
            "keywords": []
        }
    ],
    "note": "선택된 클립 - 1개 문장",
    "clipping_type": 1,
    "template_number": 11,
    "individual_clips": false,
    "study": "review",
    "title_1": "케데몽",
    "title_2": "트와이스 지짱"
}
```

### 1.2 기대 동작
- `study: "preview"`: 스피드 미리보기 클립이 맨 앞에 추가
- `study: "review"`: 스피드 복습 클립이 맨 뒤에 추가
- `study: null`: 학습 클립 생성하지 않음

## 2. 발생한 문제들

### 2.1 리뷰 클립 위치 문제
- **증상**: `study: "review"`로 요청했는데 리뷰 클립이 맨 앞에 위치
- **원인**: API 재시작이 제대로 안되어 이전 코드가 실행됨
- **해결 시도**: 
  - `kill -HUP` 시그널로 gunicorn 재로드
  - 로그에 디버깅 정보 추가하여 확인

### 2.2 오디오 누락 문제
- **증상**: 리뷰 클립에 오디오가 포함되지 않음
- **원인**: 타이틀 클립에 무음 오디오 트랙이 없어서 concat 시 문제 발생
- **해결**: 
  ```python
  # 타이틀 클립에 무음 오디오 추가
  cmd = [
      'ffmpeg', '-y',
      '-f', 'lavfi',
      '-i', f'color=c=black:s={width}x{height}:d=2',
      '-f', 'lavfi',
      '-i', 'anullsrc=channel_layout=stereo:sample_rate=44100',
      '-vf', drawtext_filter,
      '-c:v', 'libx264',
      '-c:a', 'aac',
      '-b:a', '192k',
      '-shortest',
      output_path
  ]
  ```

### 2.3 Concat 문제
- **증상**: 
  - concat 사용 시 DTS (Decode Time Stamp) 에러 발생
  - 전체 비디오 길이가 첫 번째 클립 길이와 동일 (리뷰 클립이 포함 안됨)
  - 오디오 스트림이 사라지거나 동기화 문제 발생
  
- **FFmpeg 에러 메시지**:
  ```
  [mp4 @ 0x55d60e2cb540] Non-monotonous DTS in output stream 0:0; 
  previous: 307840, current: 212077; changing to 307841. 
  This may result in incorrect timestamps in the output file.
  ```

- **시도한 해결책들**:
  
  1. **concat demuxer with copy (실패)**:
  ```bash
  ffmpeg -f concat -safe 0 -i concat_list.txt -c copy output.mp4
  ```
  - 문제: DTS 에러, 프레임 드롭

  2. **concat demuxer with re-encode (부분적 성공)**:
  ```bash
  ffmpeg -f concat -safe 0 -i concat_list.txt \
    -c:v libx264 -preset fast -crf 20 \
    -c:a aac -b:a 192k \
    output.mp4
  ```
  - 문제: 여전히 두 번째 클립(리뷰)이 포함 안됨

  3. **filter_complex 사용 (시도 중)**:
  ```bash
  ffmpeg -i clip1.mp4 -i clip2.mp4 \
    -filter_complex "[0:v][0:a][1:v][1:a]concat=n=2:v=1:a=1[outv][outa]" \
    -map "[outv]" -map "[outa]" \
    -c:v libx264 -preset fast -crf 20 \
    -c:a aac -b:a 192k -ar 44100 -ac 2 \
    output.mp4
  ```

### 2.4 자막 깨짐 문제
- **증상**: 리뷰 클립의 한글 자막이 깨져서 표시됨
- **가능한 원인**:
  1. 폰트 경로 문제
  2. drawtext 필터에서 텍스트 이스케이프 문제
  3. 인코딩 문제

### 2.5 전체 오디오 없음
- **증상**: 최종 combined 비디오에서 오디오가 전혀 재생되지 않음
- **확인 방법**:
  ```bash
  ffprobe -v error -show_streams combined.mp4 | grep codec_type
  # 결과: video와 audio 둘 다 있지만 실제로는 재생 안됨
  ```

## 3. 코드 구조

### 3.1 리뷰 클립 생성 흐름
1. `clipping_api.py`: API 엔드포인트에서 요청 처리
2. `review_clip_generator.py`: 실제 리뷰 클립 생성
   - TTS 생성 (Edge TTS 사용)
   - 타이틀 클립 생성 (2초)
   - 개별 텍스트 클립 생성 (TTS 오디오 포함)
   - concat으로 합치기

### 3.2 주요 파일 경로 및 문제 코드 위치

#### `/home/kang/dev_amd/shadowing_maker_xls/clipping_api.py`
- **라인 1105-1150**: 리뷰 클립 생성 로직
- **라인 1320-1331**: study 모드에 따른 클립 위치 결정
- **라인 1333-1373**: FFmpeg concat 문제 발생 부분 (filter_complex로 수정 시도)

#### `/home/kang/dev_amd/shadowing_maker_xls/review_clip_generator.py`
- **라인 23-74**: `create_review_clip()` 메인 함수
- **라인 104-131**: 개별 클립 생성 (FFmpeg 명령)
- **라인 147-175**: `_create_drawtext_filter()` 자막 필터 (한글 깨짐 문제)
- **라인 194-288**: `_create_title_clip()` 타이틀 클립 생성
- **라인 291-321**: `_concat_clips()` concat 로직 (문제 발생)

#### `/home/kang/dev_amd/shadowing_maker_xls/edge_tts_util.py`
- TTS 생성 유틸리티 (정상 작동)

#### `/home/kang/dev_amd/shadowing_maker_xls/template_standards.py`
- 표준화된 비디오/오디오 처리 함수들
- 폰트 로직은 여기에 없음 (template_video_encoder.py에 있음)

#### `/home/kang/dev_amd/shadowing_maker_xls/template_video_encoder.py`
- **라인 441-457**: 폰트 경로 설정 로직
- **라인 480-528**: drawtext 필터 적용 부분

## 4. 해결해야 할 문제들

1. **concat 대신 filter_complex 사용하여 안정적인 병합**
   - 모든 클립이 동일한 코덱/포맷을 갖도록 보장
   - 오디오/비디오 스트림 동기화

2. **자막 인코딩 문제 해결**
   - drawtext 필터의 텍스트 이스케이프 개선
   - 폰트 파일 경로 확인

3. **API 재시작 문제**
   - 코드 변경 후 gunicorn이 제대로 재로드되지 않음
   - 여전히 이전 코드가 실행되는 현상

4. **오디오 스트림 보존**
   - 모든 클립에 오디오 트랙이 있는지 확인
   - 병합 시 오디오가 유지되도록 보장

## 5. 테스트 결과

### 5.1 직접 테스트 (성공)
```python
# test_review_clip_direct.py 실행 결과
✓ Review clip created: test_review_output.mp4
Stream info:
  Video: ✓
  Audio: ✓
```

### 5.2 API 테스트 (실패)
- 리뷰 클립 생성은 되지만 최종 병합에서 문제 발생
- 전체 비디오 길이가 첫 번째 클립만큼만 나옴
- 오디오 누락 또는 재생 안됨

## 6. 다음 단계

1. **concat 완전 제거하고 filter_complex로 교체**
2. **모든 클립의 코덱/포맷 통일**
3. **자막 렌더링 방식 개선**
4. **API 재시작 프로세스 개선**

## 7. 테스트 방법

### 7.1 간단한 테스트 명령어
```bash
# API 테스트 (위의 실제 JSON 사용)
curl -X POST http://localhost:8080/api/clip/batch \
  -H "Content-Type: application/json" \
  -d '{
    "media_path": "/mnt/qnap/media_eng/indexed_media/Animation/KPop.Demon.Hunters.2025.1080p.WEBRip.x264.AAC5.1-[YTS.MX].mp4",
    "clips": [
        {
            "start_time": 52.127,
            "end_time": 55.187999999999995,
            "text_eng": "You will be Hunters.",
            "text_kor": "너희는 헌터가 될 거야",
            "keywords": []
        }
    ],
    "note": "선택된 클립 - 1개 문장",
    "clipping_type": 1,
    "template_number": 11,
    "individual_clips": false,
    "study": "review",
    "title_1": "케데몽",
    "title_2": "트와이스 지짱"
}'
```

### 7.2 Python 테스트 스크립트
```python
# test_exact_request.py
import requests
import json

request_data = {
    "media_path": "/mnt/qnap/media_eng/indexed_media/Animation/KPop.Demon.Hunters.2025.1080p.WEBRip.x264.AAC5.1-[YTS.MX].mp4",
    "clips": [
        {
            "start_time": 52.127,
            "end_time": 55.187999999999995,
            "text_eng": "You will be Hunters.",
            "text_kor": "너희는 헌터가 될 거야",
            "keywords": []
        }
    ],
    "note": "선택된 클립 - 1개 문장",
    "clipping_type": 1,
    "template_number": 11,
    "individual_clips": False,
    "study": "review",
    "title_1": "케데몽",
    "title_2": "트와이스 지짱"
}

response = requests.post("http://localhost:8080/api/clip/batch", json=request_data)
print(response.json())
```

### 7.3 결과 확인
```bash
# 생성된 파일 확인
ls -la /mnt/ssd1t/output/2025-08-26/{job_id}/

# 비디오 정보 확인
ffprobe -v error -show_streams {output_file} | grep codec_type

# 비디오 길이 확인
ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 {output_file}
```